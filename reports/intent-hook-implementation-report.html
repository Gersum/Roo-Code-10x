<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Intent-Driven Hook Architecture Report</title>
<style>
  @page { size: A4; margin: 18mm 14mm; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color:#111; line-height:1.45; font-size: 12px; }
  h1 { font-size: 24px; margin: 0 0 10px; }
  h2 { font-size: 18px; margin: 20px 0 8px; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
  h3 { font-size: 15px; margin: 16px 0 6px; }
  p { margin: 6px 0; }
  ul, ol { margin: 6px 0 6px 22px; }
  li { margin: 2px 0; }
  pre { background: #f6f8fa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; overflow-wrap: anywhere; white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 11px; }
  .sp { height: 4px; }
</style>
</head>
<body>
<h1>Intent-Driven Hook Architecture Report</h1>
<div class="sp"></div>
<p>Date: 2026-02-21</p>
<p>Repository: Roo-Code extension</p>
<p>Scope: Intent handshake, pre/post hook middleware, semantic traceability, optimistic locking, and safety guardrails.</p>
<div class="sp"></div>
<h2>1) Executive Summary</h2>
<div class="sp"></div>
<p>This implementation resolves the "context paradox" between asynchronous IDE interaction and synchronous LLM tool execution by introducing an explicit intent checkout handshake and deterministic hook enforcement.</p>
<div class="sp"></div>
<p>The delivered system now enforces:</p>
<div class="sp"></div>
<ul>
<li>Intent-first mutation flow (`select_active_intent` before writes/edits).</li>
<li>Strong pre-hook controls (scope, checkout stage, HITL, sidecar, intent ignore, stale-file, spec-iteration guard).</li>
<li>Post-hook semantic ledgering (`agent_trace.jsonl` with integrity chaining and mutation-class attribution).</li>
<li>Recovery and learning mechanisms (structured hook errors; verification-failure lessons captured in the repo knowledge base `AGENT.md`).</li>
</ul>
<div class="sp"></div>
<h2>2) Implemented Architecture</h2>
<div class="sp"></div>
<h3>2.1 Components</h3>
<div class="sp"></div>
<ol>
<li>Prompt Handshake Contract</li>
</ol>
<div class="sp"></div>
<ul>
<li>File: `src/core/prompts/system.ts`</li>
<li>Injects a mandatory intent protocol in the system prompt:</li>
</ul>
<p>    - First mutating flow must call `select_active_intent`.</p>
<p>    - Mutating tools forbidden until checkout succeeds.</p>
<div class="sp"></div>
<ol>
<li>Intent Selection Tool + Context Loader</li>
</ol>
<div class="sp"></div>
<ul>
<li>Tool schema: `src/core/prompts/tools/native-tools/select_active_intent.ts`</li>
<li>Runtime tool: `src/core/tools/SelectActiveIntentTool.ts`</li>
<li>Context source: `.orchestration/active_intents.yaml` via `IntentContextService`.</li>
<li>Hook interception (`HookEngine.preToolUse`) constructs and injects `&lt;intent_context&gt;` XML for selected intent.</li>
</ul>
<div class="sp"></div>
<ol>
<li>Hook Middleware (Pre/Post)</li>
</ol>
<div class="sp"></div>
<ul>
<li>File: `src/hooks/HookEngine.ts`</li>
<li>Pre-hook controls:</li>
</ul>
<p>    - Command classification (`safe` vs `destructive`).</p>
<p>    - Two-stage checkout state machine (`checkout_required` â†’ `execution_authorized`).</p>
<p>    - Contract validation for `.orchestration` control-plane files.</p>
<p>    - Sidecar policy (`constraints.sidecar.yaml`) and deny-list checks.</p>
<p>    - Workspace boundary and owned-scope enforcement.</p>
<p>    - `.intentignore` intent exclusion.</p>
<p>    - HITL modal/ask gate (`Approve/Reject`).</p>
<p>    - Optimistic lock stale-file blocking.</p>
<p>    - Numbered spec creation guard (new `specs/NNN-*` requires `INTENT_EVOLUTION`).</p>
<ul>
<li>Post-hook controls:</li>
</ul>
<p>    - Governance ledger append.</p>
<p>    - Intent history/status updates.</p>
<p>    - Semantic trace serialization to `agent_trace.jsonl`.</p>
<div class="sp"></div>
<ol>
<li>Orchestration Persistence Layer</li>
</ol>
<div class="sp"></div>
<ul>
<li>File: `src/hooks/OrchestrationStore.ts`</li>
<li>Manages:</li>
</ul>
<p>    - `active_intents.yaml`</p>
<p>    - `agent_trace.jsonl`</p>
<p>    - `intent_map.md`</p>
<p>    - `governance_ledger.md`</p>
<p>    - `constraints.sidecar.yaml`</p>
<p>    - `.intentignore`</p>
<ul>
<li>Validates agent trace schema with Zod and adds SHA-256 chain integrity (`prev_record_hash`, `record_hash`).</li>
</ul>
<div class="sp"></div>
<ol>
<li>Dispatch Shim for Write Robustness</li>
</ol>
<div class="sp"></div>
<ul>
<li>File: `src/core/assistant-message/presentAssistantMessage.ts`</li>
<li>`normalizeWriteToFileToolUseForDispatch(...)` behavior:</li>
</ul>
<p>    - If `write_to_file.intent_id` missing and `task.activeIntentId` exists: auto-fill.</p>
<p>    - If `mutation_class` missing: default `AST_REFACTOR`.</p>
<p>    - Hard fail only if no active intent exists.</p>
<div class="sp"></div>
<ol>
<li>Optimistic Concurrency + Lessons Learned</li>
</ol>
<div class="sp"></div>
<ul>
<li>Read hash capture: `src/core/tools/ReadFileTool.ts`</li>
<li>Turn-scoped hash store: `src/core/task/Task.ts`</li>
<li>Stale-file detection pre-write: `src/hooks/HookEngine.ts`</li>
<li>Verification failure lesson append: `src/core/tools/ExecuteCommandTool.ts` (repo knowledge base target: `AGENT.md`)</li>
</ul>
<div class="sp"></div>
<h2>3) Schemas and Contracts</h2>
<div class="sp"></div>
<h3>3.1 Native Tool Schema: `select_active_intent`</h3>
<div class="sp"></div>
<p>Source: `src/core/prompts/tools/native-tools/select_active_intent.ts`</p>
<div class="sp"></div>
<pre><code>
{
	"name": "select_active_intent",
	"parameters": {
		"type": "object",
		"properties": {
			"intent_id": { "type": "string" }
		},
		"required": ["intent_id"],
		"additionalProperties": false
	}
}
</code></pre>
<div class="sp"></div>
<h3>3.2 Native Tool Schema: `write_to_file`</h3>
<div class="sp"></div>
<p>Source: `src/core/prompts/tools/native-tools/write_to_file.ts`</p>
<div class="sp"></div>
<pre><code>
{
	"name": "write_to_file",
	"parameters": {
		"type": "object",
		"properties": {
			"path": { "type": "string" },
			"content": { "type": "string" },
			"intent_id": { "type": "string" },
			"mutation_class": {
				"type": "string",
				"enum": ["AST_REFACTOR", "INTENT_EVOLUTION"]
			}
		},
		"required": ["path", "content", "intent_id", "mutation_class"],
		"additionalProperties": false
	}
}
</code></pre>
<div class="sp"></div>
<h3>3.3 Agent Trace Record Schema</h3>
<div class="sp"></div>
<p>Source: `src/hooks/OrchestrationStore.ts`</p>
<div class="sp"></div>
<p>Record includes:</p>
<div class="sp"></div>
<ul>
<li>`id`, `timestamp`, `vcs.revision_id`</li>
<li>`files[]` with:</li>
</ul>
<p>    - `relative_path`</p>
<p>    - optional `ast_fingerprint` (`parser=tree-sitter`, `summary_hash=sha256:...`)</p>
<p>    - `conversations[]`:</p>
<p>        - `url`, `contributor`</p>
<p>        - `ranges[]` (`start_line`, `end_line`, `content_hash`)</p>
<p>        - `related[]`: `specification` and optional `mutation_class`</p>
<ul>
<li>optional `integrity`:</li>
</ul>
<p>    - `chain=sha256`</p>
<p>    - `prev_record_hash`</p>
<p>    - `record_hash`</p>
<div class="sp"></div>
<p>Validation:</p>
<div class="sp"></div>
<ul>
<li>Zod schema checks UUID, timestamp format, hash regex, range semantics.</li>
</ul>
<div class="sp"></div>
<h2>4) Detailed Agent Flow (Turn Lifecycle)</h2>
<div class="sp"></div>
<h3>4.1 Stage A: Intent Declaration</h3>
<div class="sp"></div>
<ol>
<li>Model analyzes user request.</li>
<li>Model calls `select_active_intent(intent_id)`.</li>
<li>Pre-hook intercepts and loads intent from active intents store.</li>
<li>Hook injects `&lt;intent_context&gt;` XML (scope + constraints).</li>
<li>`SelectActiveIntentTool` authorizes checkout for the turn (`execution_authorized`).</li>
</ol>
<div class="sp"></div>
<h3>4.2 Stage B: Tool Dispatch and Pre-Hook Gating</h3>
<div class="sp"></div>
<p>For each tool call:</p>
<div class="sp"></div>
<ol>
<li>Dispatch shim normalizes `write_to_file` args (intent/mutation defaults).</li>
<li>Pre-hook evaluates:</li>
</ol>
<p>    - mutating tool classification</p>
<p>    - checkout stage gate</p>
<p>    - orchestration contract drift</p>
<p>    - sidecar blocked tools / denied mutation paths</p>
<p>    - out-of-workspace mutations</p>
<p>    - active intent validity</p>
<p>    - `.intentignore` pattern exclusion</p>
<p>    - `owned_scope` membership</p>
<p>    - stale file check (optimistic lock)</p>
<p>    - numbered spec creation guard (`specs/NNN-*` + mutation class)</p>
<p>    - HITL approval</p>
<ol>
<li>On deny: standardized hook error or explicit scope message is returned.</li>
</ol>
<div class="sp"></div>
<h3>4.3 Stage C: Tool Execution</h3>
<div class="sp"></div>
<ul>
<li>Tool executes only after passing pre-hook.</li>
<li>`write_to_file` still performs its own required-param checks and approval flow.</li>
</ul>
<div class="sp"></div>
<h3>4.4 Stage D: Post-Hook Audit and Trace</h3>
<div class="sp"></div>
<ol>
<li>Governance ledger append (`OK|FAILED|DENIED` metadata).</li>
<li>Intent `recent_history` update.</li>
<li>For successful mutating tools:</li>
</ol>
<p>    - Build trace record with content hash and optional AST fingerprint.</p>
<p>    - Inject `specification` and `mutation_class` in `related[]`.</p>
<p>    - Append to `agent_trace.jsonl` with chain integrity.</p>
<ol>
<li>`attempt_completion` success marks intent `COMPLETED`.</li>
</ol>
<div class="sp"></div>
<h2>5) Guardrails Implemented (What Blocks What)</h2>
<div class="sp"></div>
<ol>
<li>Missing Intent Gate</li>
</ol>
<div class="sp"></div>
<ul>
<li>Error: `You must cite a valid active Intent ID.`</li>
<li>Trigger: no active intent or invalid id for mutating tool.</li>
</ul>
<div class="sp"></div>
<ol>
<li>Checkout Stage Gate</li>
</ol>
<div class="sp"></div>
<ul>
<li>Error: `PreToolUse denied ... intent checkout required for this turn.`</li>
<li>Trigger: mutating tool before `select_active_intent` in current turn.</li>
</ul>
<div class="sp"></div>
<ol>
<li>Scope Gate</li>
</ol>
<div class="sp"></div>
<ul>
<li>Error: `Scope Violation: &lt;REQ/INTENT&gt; is not authorized to edit &lt;path&gt;. Request scope expansion.`</li>
<li>Trigger: write outside `owned_scope`.</li>
</ul>
<div class="sp"></div>
<ol>
<li>Intent Ignore Gate</li>
</ol>
<div class="sp"></div>
<ul>
<li>Structured error code: `INTENT_IGNORED`</li>
<li>Trigger: active intent matched in `.intentignore`.</li>
</ul>
<div class="sp"></div>
<ol>
<li>Stale File Gate</li>
</ol>
<div class="sp"></div>
<ul>
<li>Structured error code: `STALE_FILE`</li>
<li>Trigger: file changed since it was read this turn.</li>
</ul>
<div class="sp"></div>
<ol>
<li>HITL Authorization Gate</li>
</ol>
<div class="sp"></div>
<ul>
<li>Structured error code: `HITL_REJECTED`</li>
<li>Trigger: user reject in modal/ask flow.</li>
</ul>
<div class="sp"></div>
<ol>
<li>Spec Iteration Gate (new)</li>
</ol>
<div class="sp"></div>
<ul>
<li>Structured error code: `SPEC_ITERATION_REQUIRES_INTENT_EVOLUTION`</li>
<li>Trigger: creating new `specs/NNN-*` file with non-`INTENT_EVOLUTION` mutation class.</li>
</ul>
<div class="sp"></div>
<h2>6) Traceability and Integrity Notes</h2>
<div class="sp"></div>
<ul>
<li>Content hashing:</li>
</ul>
<p>    - Reads/writes use SHA-256 for stale-file checks and trace ranges.</p>
<ul>
<li>Chain-of-custody:</li>
</ul>
<p>    - `agent_trace.jsonl` links entries via `prev_record_hash` -&gt; `record_hash`.</p>
<ul>
<li>Semantic attribution:</li>
</ul>
<p>    - `mutation_class` persisted for downstream audits (`AST_REFACTOR` vs `INTENT_EVOLUTION`).</p>
<ul>
<li>Scope + decision provenance:</li>
</ul>
<p>    - `governance_ledger.md` records status, tool, intent, touched paths, sidecar constraints.</p>
<div class="sp"></div>
<h2>7) What Has Been Achieved</h2>
<div class="sp"></div>
<h3>Completed Capabilities</h3>
<div class="sp"></div>
<ul>
<li>Intent-first protocol integrated into system prompt and runtime execution.</li>
<li>Deterministic pre-hook governance over all mutating flows.</li>
<li>Formal tool schema enforcement for intent + mutation semantics.</li>
<li>Automatic write shim to reduce model/tooling friction.</li>
<li>Scope and boundary protection with actionable errors.</li>
<li>HITL approval integrated into pre-dispatch gate.</li>
<li>Optimistic locking to prevent parallel overwrite races.</li>
<li>Agent trace ledger with semantic + cryptographic integrity metadata.</li>
<li>Verification-failure lesson persistence to `AGENT.md`.</li>
<li>New numbered-spec creation guardrail tied to mutation semantics.</li>
</ul>
<div class="sp"></div>
<h3>Operational Impact</h3>
<div class="sp"></div>
<ul>
<li>Eliminates silent context drift between user intent and write execution.</li>
<li>Converts failures into structured recoverable tool errors.</li>
<li>Increases trust with auditable, hash-linked mutation records.</li>
<li>Supports safe parallel workflows by blocking stale writes.</li>
</ul>
<div class="sp"></div>
<h2>8) Validation Evidence</h2>
<div class="sp"></div>
<p>Focused tests and checks executed for this implementation:</p>
<div class="sp"></div>
<ul>
<li>Typecheck: `pnpm -C src check-types`</li>
<li>Tests:</li>
</ul>
<p>    - `src/hooks/__tests__/HookEngine.spec.ts`</p>
<p>    - `src/core/assistant-message/__tests__/presentAssistantMessage-writeToFile-shim.spec.ts`</p>
<ul>
<li>Result: Passing (including new spec-iteration deny/allow tests).</li>
</ul>
<div class="sp"></div>
<h2>9) Known Constraints / Follow-ups</h2>
<div class="sp"></div>
<ol>
<li>`apply_diff` matching is brittle in high-churn sections (`recent_history`); safer patch anchors are recommended.</li>
<li>The write shim applies only to `write_to_file`; similar normalizers could be added for future schema-evolving mutators.</li>
<li>Telemetry and governance rollups are implemented (`src/hooks/GovernanceRollupService.ts`) and can be further extended with webview dashboard visualizations.</li>
</ol>
<div class="sp"></div>
<h2>10) End to End architecture</h2>
<div class="sp"></div>
<p>flowchart TD</p>
<p>subgraph UI_Plane [UI Plane]</p>
<p>U[User]</p>
<p>WV[Webview UI]</p>
<p>end</p>
<div class="sp"></div>
<p>    subgraph Logic_Plane [Logic Plane]</p>
<p>        WMH[webviewMessageHandler]</p>
<p>        CP[ClineProvider]</p>
<p>        TK[Task Runtime]</p>
<p>        API[Assistant API]</p>
<p>        NTP[NativeToolCallParser]</p>
<p>        DISPATCH[presentAssistantMessage]</p>
<p>        HOOK[HookEngine]</p>
<p>        STORE[OrchestrationStore]</p>
<p>    end</p>
<div class="sp"></div>
<p>    subgraph Execution_Plane [Execution Plane]</p>
<p>        TOOLS[Tool Implementations]</p>
<p>        FS[Workspace File System / Terminal / MCP]</p>
<p>    end</p>
<div class="sp"></div>
<p>    subgraph Persistence_Plane [Persistence Plane]</p>
<p>        ORCH[".orchestration/*"]</p>
<p>        ACTINT["active_intents.yaml"]</p>
<p>        SIDECAR["sidecar.yaml"]</p>
<p>        TRACE["agent_trace.jsonl"]</p>
<p>        MAP["intent_map.md"]</p>
<p>        AGENT["AGENT.md / shared brain"]</p>
<p>    end</p>
<div class="sp"></div>
<p>    %% Connections</p>
<p>    U --&gt;|interacts| WV</p>
<p>    WV --&gt;|postMessage| WMH</p>
<p>    WMH --&gt; CP</p>
<p>    CP --&gt; TK</p>
<p>    TK --&gt;|build prompt &amp; tools| API</p>
<p>    API --&gt;|streamed response| NTP</p>
<p>    NTP --&gt; DISPATCH</p>
<div class="sp"></div>
<p>    DISPATCH --&gt;|preToolUse| HOOK</p>
<p>    HOOK --&gt;|policy &amp; state| STORE</p>
<p>    STORE --&gt; ORCH</p>
<p>    HOOK -- allow/deny --&gt; DISPATCH</p>
<div class="sp"></div>
<p>    DISPATCH --&gt;|execute| TOOLS</p>
<p>    TOOLS --&gt; FS</p>
<p>    TOOLS --&gt;|results| DISPATCH</p>
<div class="sp"></div>
<p>    DISPATCH --&gt;|postToolUse| HOOK</p>
<p>    HOOK --&gt;|write logs| STORE</p>
<p>    STORE --&gt; ORCH</p>
<p>    ORCH --&gt;|data| STORE</p>
<div class="sp"></div>
<h2>11) File Index (Primary Implementation)</h2>
<div class="sp"></div>
<ul>
<li>`src/core/prompts/system.ts`</li>
<li>`src/core/prompts/tools/native-tools/select_active_intent.ts`</li>
<li>`src/core/prompts/tools/native-tools/write_to_file.ts`</li>
<li>`src/core/tools/SelectActiveIntentTool.ts`</li>
<li>`src/core/tools/WriteToFileTool.ts`</li>
<li>`src/core/assistant-message/presentAssistantMessage.ts`</li>
<li>`src/hooks/HookEngine.ts`</li>
<li>`src/hooks/OrchestrationStore.ts`</li>
<li>`src/hooks/IntentContextService.ts`</li>
<li>`src/core/task/Task.ts`</li>
<li>`src/core/tools/ReadFileTool.ts`</li>
<li>`src/core/tools/ExecuteCommandTool.ts`</li>
<li>`src/hooks/__tests__/HookEngine.spec.ts`</li>
<li>`src/core/assistant-message/__tests__/presentAssistantMessage-writeToFile-shim.spec.ts`</li>
</ul>
<div class="sp"></div>
<p>---</p>
<div class="sp"></div>
<p>github link : https://github.com/Gersum/Roo-Code-10x.git</p>
<div class="sp"></div>
</body>
</html>